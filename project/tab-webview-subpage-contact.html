<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		
		<link rel="stylesheet" href="../css/mui.min.css">
		<script src="../js/mui.min.js"></script>
		<script src="../js/jquery-2.1.4.min.js"></script>
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			p {
				text-indent: 22px;
			}
			span.mui-icon {
				font-size: 14px;
				color: #007aff;
				margin-left: -15px;
				padding-right: 10px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-menu mui-icon mui-icon-bars mui-pull-left"></a>
			<a class="mui-action-back mui-btn mui-btn-link mui-pull-right">关闭</a>
			<h1 class="mui-title">影视</h1>
		</header>
		<div class="mui-content">
			<div id="refreshContainer" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				
			</div>
		</div>
		</div>
	</body>
	
	<script>
		let taburl = "http://www.qyl077.com/categories/categories/";
		let loadType = "guochan";
		let page = 2
		var main,menu, mask = mui.createMask(_closeMenu);
		var showMenu = false,mode = 'all-move';
		 
		if (!mui.os.android) {
			//整体滑动暂不支持android手机，因为两个页面的移动动画，无法保证同步性；
			document.getElementById("move-togger").classList.remove('mui-hidden');
			var spans = document.querySelectorAll('.android-only');
			for (var i=0,len=spans.length;i<len;i++) {
				spans[i].style.display = "none";
			}
		}

		mui.init({
			swipeBack: false,
			beforeback: back,
			pullRefresh: {
				container: "#refreshContainer", //下拉刷新容器标识，querySelector能定位的css选择器均可，比如：id、.class等
				down: {
					style: 'circle', //必选，下拉刷新样式，目前支持原生5+ ‘circle’ 样式
					color: '#2BD009', //可选，默认“#2BD009” 下拉刷新控件颜色
					height: '50px', //可选,默认50px.下拉刷新控件的高度,
					range: '100px', //可选 默认100px,控件可下拉拖拽的范围
					offset: '10px', //可选 默认0px,下拉刷新控件的起始位置
					auto: true, //可选,默认false.首次加载自动上拉刷新一次
					callback: pulldownRefresh //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
				},
				up: {
					height: 50, //可选.默认50.触发上拉加载拖动距离
					auto: false, //可选,默认false.自动上拉加载一次
					contentrefresh: "正在加载...", //可选，正在加载状态时，上拉加载控件上显示的标题内容
					contentnomore: '没有更多数据了', //可选，请求完毕若没有更多数据时显示的提醒内容；
					callback: pullupRefresh //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
				}
			}
		});
		
		
		
		function pulldownRefresh() {
			$(".mui-scroll").empty();
			page = 2;
			loadData();
			mui('#refreshContainer').pullRefresh().endPulldownToRefresh();
		}

		function pullupRefresh() {
			page++;
			loadData();
			mui('#refreshContainer').pullRefresh().endPullupToRefresh(false);
		}
		

		function loadData() {
			const url = 'http://www.qyl077.com/' + loadType + '/recent/' + page;
			mui.ajax(url, {
				type: 'get', //HTTP请求类型
				async: false,
				success: function(html) {
					doData(html);
				}
			});
		}

			function doData(html) {
				var el = document.createElement('div')
				el.innerHTML = html;
				$(el).find(".videos").children('li').each(function(){
				var	html = '<div class="mui-card" >'+	
							  	'<div class="mui-card-header mui-card-media">'+
									'<div class="mui-media-body">'+
										$(this).find('.video-title').html() +
									'</div>'+
								'</div>'+
								'<div class="mui-card-content">'+
									'<img src="'+ $(this).find('.video-thumb img').attr('src') +'">' +
								'</div>'+
								'<div class="loadMoreDiv">'+
									'<span class="loadMoreSpan">点击上方图片进入图集</span>'+
						  			'<img src="../images/bookmark_unexpand_icon.png" height="20px" width="10%" style="float: right;margin-right: 10px;">'+
						  		'</div>'+
						  	'</div>';
				$(".mui-scroll").append(html);
				})
			}
		
		

		function back() {
			if (showMenu) {
				//菜单处于显示状态，返回键应该先关闭菜单,阻止主窗口执行mui.back逻辑；
				closeMenu();
				return false;
			} else {
				//菜单处于隐藏状态，执行返回时，要先close菜单页面，然后继续执行mui.back逻辑关闭主窗口；
				menu.close('none');
				return true;
			}
		}
		//plusReady事件后，自动创建menu窗口；
		mui.plusReady(function() {
			main = plus.webview.currentWebview();
			//setTimeout的目的是等待窗体动画结束后，再执行create webview操作，避免资源竞争，导致窗口动画不流畅；
			setTimeout(function () {
				//侧滑菜单默认隐藏，这样可以节省内存；
				menu = mui.preload({
					id: 'offcanvas-drag-right-plus-menu',
					url: 'offcanvas-drag-right-plus-menu.html',
					styles: {
						left: 0,
						width: '70%',
						zindex: 9997
					}
				});
			},300);
			
		});
		/**
		 * 显示菜单菜单
		 */
		function openMenu() {
			if (!showMenu) {
				//侧滑菜单处于隐藏状态，则立即显示出来；
				//显示完毕后，根据不同动画效果移动窗体；
				menu.show('none', 0, function() {
					main.setStyle({
						left: '70%',
						transition: {
							duration: 150
						}
					});
					menu.setStyle({
						left: '0%',
						transition: {
							duration: 150
						}
					});
				});
				//显示遮罩
				mask.show();
				showMenu = true;
			}
		}
		/**
		 * 关闭侧滑菜单
		 */
		function closeMenu () {
			_closeMenu();
			//关闭遮罩
			mask.close();
		}
		
		/**
		 * 关闭侧滑菜单（业务部分）
		 */
		function _closeMenu() {
			if (showMenu) {
				//主窗体开始侧滑；
				main.setStyle({
					left: '0',
					transition: {
						duration: 150
					}
				});
				//menu页面同时移动
				menu.setStyle({
					left: '-70%',
					transition: {
						duration: 150
					}
				});
				
				//等窗体动画结束后，隐藏菜单webview，节省资源；
				setTimeout(function() {
					menu.hide();
				}, 200);
				//改变标志位
				showMenu = false;
			}
		}
		
		//变换侧滑动画移动效果；
		mui('.mui-input-group').on('change', 'input', function() {
			if (this.checked) {
				switch (this.value) {
					case 'main-move':
						//仅主窗口移动的时候，menu页面的zindex值要低一点；
						menu.setStyle({left:'0',zindex:9997});
						if(mode=='all-move'){
							menu.setStyle({
								left: '0%'
							});
						}
						mode = 'main-move';
						break;
					case 'menu-move':
						menu.setStyle({left:'-70%',zindex:9999});
						if(mode=='all-move'){
							menu.setStyle({
								left: '0%'
							});
						}
						mode = 'menu-move';
						break;
					case 'all-move':
						//切换为整体移动
						//首先改变移动标志
						slideTogether = true;
						//变换menu界面初始化位置，整体移动时，Menu界面left需要在-70%的地方；
						menu.setStyle({
							left: '-70%'
						});
						mode = 'all-move';
						break;
				}
			}
		});

		 //点击左上角图标，打开侧滑菜单；
		document.querySelector('.mui-icon-bars').addEventListener('tap', openMenu);
		 //在android4.4中的swipe事件，需要preventDefault一下，否则触发不正常
		 //故，在dragleft，dragright中preventDefault
		window.addEventListener('dragright', function(e) {
			e.detail.gesture.preventDefault();
		});
		window.addEventListener('dragleft', function(e) {
			e.detail.gesture.preventDefault();
		});
		 //主界面向右滑动，若菜单未显示，则显示菜单；否则不做任何操作；
		window.addEventListener("swiperight", openMenu);
		 //主界面向左滑动，若菜单已显示，则关闭菜单；否则，不做任何操作；
		window.addEventListener("swipeleft", closeMenu);
		 //menu页面向左滑动，关闭菜单；
		window.addEventListener("menu:swipeleft", closeMenu);

		//重写mui.menu方法，Android版本menu按键按下可自动打开、关闭侧滑菜单；
		mui.menu = function() {
			if (showMenu) {
				closeMenu();
			} else {
				openMenu();
			}
		}
	</script>
</html>